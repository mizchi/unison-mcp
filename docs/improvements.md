# Unison MCP Server 改善点

## 現在の実装の課題と改善案

### 1. UCM統合の改善
**現状の課題:**
- UCMプロセスとの通信が単純なstdin/stdout経由
- 出力のパースが不完全
- エラーハンドリングが不十分

**改善案:**
- UCMの内部APIを直接使用する
- より堅牢な出力パーサーの実装
- 非同期処理の改善

### 2. エラーハンドリング
**現状の課題:**
- UCMエラーが適切にMCPエラーに変換されない
- タイムアウト処理が単純

**改善案:**
```haskell
data UCMError 
  = UCMTimeout
  | UCMParseError Text
  | UCMCommandError Text
  | UCMNotFound Text

handleUCMError :: UCMError -> MCPError
```

### 3. より多くのUCMコマンドサポート
**追加すべきコマンド:**
- `merge` - ブランチのマージ
- `pull` / `push` - リモートとの同期
- `test` - テストの実行
- `docs` - ドキュメントの取得
- `refactor.rename` - リファクタリング
- `todo` - TODOリストの管理

### 4. ストリーミングサポート
**改善案:**
- 長時間実行されるコマンドの進捗表示
- リアルタイムのログ出力

### 5. セッション管理
**改善案:**
- 複数のUCMセッションの管理
- コンテキストの保持
- トランザクション的な操作

### 6. 型安全性の向上
```haskell
-- 現在
runExpression :: UCMHandle -> Text -> IO Text

-- 改善後
runExpression :: UCMHandle -> UnisonExpression -> IO (Either UCMError UnisonValue)
```

### 7. テストの充実
- 統合テストの追加
- UCMモックの実装
- プロパティベーステスト

### 8. パフォーマンス最適化
- UCMプロセスの再利用
- 結果のキャッシング
- バッチ処理のサポート

### 9. セキュリティ強化
- サンドボックス実行
- 権限管理
- 監査ログ

### 10. ドキュメント生成
- OpenAPIスペックの自動生成
- インタラクティブなドキュメント
- 使用例の自動テスト

## 実装優先順位

1. **高優先度**
   - エラーハンドリングの改善
   - より多くのUCMコマンドサポート
   - テストの充実

2. **中優先度**
   - ストリーミングサポート
   - セッション管理
   - パフォーマンス最適化

3. **低優先度**
   - セキュリティ強化
   - ドキュメント生成
   - 高度な型安全性

## 次のステップ

1. UCMの内部APIを調査し、直接統合の可能性を検討
2. エラーハンドリングの改善を実装
3. 主要なUCMコマンドを追加
4. 実際のユースケースでのテスト